name: "Publish Ambassador-Agent Image"

on:
  push:
    tags:
      - v*

jobs:
  build:

    runs-on: ubuntu-latest

    steps:
    - name: Git checkout
      uses: actions/checkout@v2

    - name: Docker login
      uses: docker/login-action@v1
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_TOKEN }}
    
    - name: Set up QEMU
      uses: docker/setup-qemu-action@v1
      with:
        platforms: arm64
    
    - name: Set up Docker Buildx
      id: buildx
      uses: docker/setup-buildx-action@v1
      with:
        driver-opts: network=host
    
    - name: Inspect builder
      run: |
        echo "Name:      ${{ steps.buildx.outputs.name }}"
        echo "Endpoint:  ${{ steps.buildx.outputs.endpoint }}"
        echo "Status:    ${{ steps.buildx.outputs.status }}"
        echo "Flags:     ${{ steps.buildx.outputs.flags }}"
        echo "Platforms: ${{ steps.buildx.outputs.platforms }}" 

    - name: Available platforms
      run: echo ${{ steps.buildx.outputs.platforms }}

    - name: Extract version
      run: |
        TAG=${GITHUB_REF#refs/*/v}
        echo "Going to build and publish: ${TAG}"
        echo "TAG=${TAG}" >> $GITHUB_ENV

    - name: Build and Publish
      run: |
        if docker pull ambassador/ambassador-agent:${{ env.TAG }}; then
          echo "Failure: Tag already exists"
          exit 1
        fi 
        docker buildx build --push --platform=linux/amd64,linux/arm64 --tag=ambassador/ambassador-agent:${{ env.TAG }} .

